<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendamento de Almoço para Missionários</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
    :root { --primary: #6c63ff; --success: #00bf8e; --danger: #f5365c; --gray: #adb5bd; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Poppins", sans-serif; background: linear-gradient(to top, #f3e7e9 0%, #e3eeff 99%); min-height: 100vh; padding: 10px; }
    .container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(108,99,255,0.15); }
    header { background: var(--primary); color: white; padding: 2rem 1.5rem; text-align: center; }
    header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    header p { opacity: 0.9; font-size: 1.1rem; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: #f8f9fa; flex-wrap: wrap; gap: 1rem; }
    .calendar-header h2 { font-size: 1.6rem; color: #343a40; }
    .nav-btn { background: var(--primary); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 1.8rem; cursor: pointer; }
    .nav-btn:hover { background: #5a52e0; transform: scale(1.1); }
    .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--primary); color: white; font-weight: 600; }
    .weekdays div { text-align: center; padding: 1rem 0.5rem; font-size: 0.9rem; }
    .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #e9ecef; padding: 5px; }
    .day { background: white; min-height: 100px; padding: 0.8rem; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; border-radius: 12px; }
    .day:hover { background: #f1f3ff; transform: translateY(-4px); box-shadow: 0 10px 20px rgba(108,99,255,0.1); }
    .day.other-month { opacity: 0.4; background: #f8f9fa; }
    .day.today { background: #fff4e6; border: 3px solid #ffa502; font-weight: 700; }
    .day.booked { background: var(--success); color: white; }
    .day-number { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.5rem; }
    .person { font-size: 0.82rem; margin-top: auto; font-weight: 500; word-break: break-all; line-height: 1.3; }
    .cancel-btn { margin-top: 8px; background: var(--danger); color: white; border: none; padding: 6px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: white; padding: 2rem; border-radius: 20px; width: 100%; max-width: 420px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    .modal input { width: 100%; padding: 14px; margin: 12px 0; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem; }
    .btn { padding: 14px 28px; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer; margin: 8px; min-width: 120px; }
    .btn-confirm { background: var(--success); color: white; }
    .btn-cancel, .btn-close { background: var(--gray); color: white; }
    .btn-close { background: var(--primary); }
    .loading { text-align: center; padding: 2rem; color: #666; }
    @media (max-width: 768px) { header h1 { font-size: 1.7rem; } .day { min-height: 90px; } .day-number { font-size: 1.2rem; } }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Agendamento de Almoço</h1>
      <p>Para nossos queridos missionários ❤️</p>
    </header>

    <div class="calendar-header">
      <button class="nav-btn" id="prevMonth">‹</button>
      <h2 id="monthYear"></h2>
      <button class="nav-btn" id="nextMonth">›</button>
    </div>

    <div class="weekdays">
      <div>Domingo</div><div>Segunda</div><div>Terça</div><div>Quarta</div><div>Quinta</div><div>Sexta</div><div>Sábado</div>
    </div>

    <div id="calendarDays" class="days"></div>
    <div id="loading" class="loading">Carregando agendamentos...</div>
  </div>

  <!-- Modais -->
  <div id="bookingModal" class="modal"><div class="modal-content">
    <h3>Agendar • <span id="selectedDate"></span></h3>
    <input type="text" id="personName" placeholder="Seu nome completo" />
    <input type="tel" id="personPhone" placeholder="Telefone com DDD" />
    <div><button class="btn btn-confirm" onclick="confirmBooking()">Confirmar</button>
    <button class="btn btn-cancel" onclick="closeModal('bookingModal')">Cancelar</button></div>
  </div></div>

  <div id="confirmModal" class="modal"><div class="modal-content">
    <h3>✅ Agendamento Confirmado!</h3>
    <p><strong>Data:</strong> <span id="confirmDate"></span></p>
    <p><strong>Nome:</strong> <span id="confirmName"></span></p>
    <p><strong>Telefone:</strong> <span id="confirmPhone"></span></p>
    <div><button class="btn btn-close" onclick="closeModal('confirmModal')">Voltar</button></div>
  </div></div>

<script>
// ==================== CONFIGURAÇÃO (só altere aqui) ====================
const REPO = "ansulima/almoco-missionarios";
const FILE_PATH = "data/bookings.json";
const RAW_URL = `https://raw.githubusercontent.com/${REPO}/master/${FILE_PATH}`;
const API_URL = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;
// =========================================================================

const API_URL = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;

let bookings = {};
let currentMonth, currentYear;
let selectedDate = null;

async function fetchBookings() {
  try {
    const response = await fetch(API_URL, { headers: { Authorization: `token ${GITHUB_TOKEN}` }});
    if (response.status === 404) {
      bookings = {};
    } else {
      const data = await response.json();
      bookings = JSON.parse(atob(data.content));
    }
  } catch (e) {
    document.getElementById("loading").innerHTML = "Erro ao carregar agendamentos. Verifique o token.";
  }
  document.getElementById("loading").style.display = "none";
  renderCalendar(currentMonth, currentYear);
}

async function saveBookings() {
  const content = btoa(JSON.stringify(bookings, null, 2));
  const response = await fetch(API_URL, {
    method: "GET",
    headers: { Authorization: `token ${GITHUB_TOKEN}` }
  });
  let sha = null;
  if (response.ok) {
    const data = await response.json();
    sha = data.sha;
  }

  await fetch(API_URL, {
    method: "PUT",
    headers: {
      Authorization: `token ${GITHUB_TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Atualização de agendamento de almoço",
      content: content,
      sha: sha
    })
  });
}

function renderCalendar(month, year) {
  document.getElementById("calendarDays").innerHTML = "";
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();

  const monthName = new Date(year, month).toLocaleString('pt-BR', { month: 'long' });
  document.getElementById("monthYear").textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} de ${year}`;

  for (let i = 0; i < firstDay; i++) {
    document.getElementById("calendarDays").innerHTML += `<div class="day other-month"></div>`;
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayEl = document.createElement("div");
    dayEl.className = "day";
    dayEl.innerHTML = `<div class="day-number">${day}</div>`;

    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
      dayEl.classList.add("today");
    }

    if (bookings[dateStr]) {
      dayEl.classList.add("booked");
      dayEl.innerHTML += `<div class="person">${bookings[dateStr].name}</div>
        <button class="cancel-btn" onclick="cancelBooking('${dateStr}', event)">Cancelar</button>`;
    } else {
      dayEl.onclick = () => {
        selectedDate = dateStr;
        document.getElementById("selectedDate").textContent = formatDate(dateStr);
        openModal("bookingModal");
      };
    }

    document.getElementById("calendarDays").appendChild(dayEl);
  }
}

function formatDate(dateStr) {
  const date = new Date(dateStr + 'T12:00:00');
  return date.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })
    .replace(/^\w/, c => c.toUpperCase());
}

function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) {
  document.getElementById(id).style.display = "none";
  if (id === "bookingModal") {
    document.getElementById("personName").value = "";
    document.getElementById("personPhone").value = "";
  }
}

async function confirmBooking() {
  const name = document.getElementById("personName").value.trim();
  const phone = document.getElementById("personPhone").value.trim();
  if (!name || !phone) return alert("Preencha nome e telefone!");

  bookings[selectedDate] = { name, phone };
  await saveBookings();
  closeModal("bookingModal");
  document.getElementById("confirmDate").textContent = formatDate(selectedDate);
  document.getElementById("confirmName").textContent = name;
  document.getElementById("confirmPhone").textContent = phone;
  openModal("confirmModal");
  renderCalendar(currentMonth, currentYear);
}

async function cancelBooking(dateStr, event) {
  event.stopPropagation();
  if (confirm(`Cancelar agendamento de ${bookings[dateStr].name}?`)) {
    delete bookings[dateStr];
    await saveBookings();
    renderCalendar(currentMonth, currentYear);
  }
}

// Navegação de meses
document.getElementById("prevMonth").onclick = () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(currentMonth, currentYear); };
document.getElementById("nextMonth").onclick = () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(currentMonth, currentYear); };

// Iniciar
currentMonth = new Date().getMonth();
currentYear = new Date().getFullYear();
fetchBookings();
</script>
</body>
</html>
