<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendamento de Almo√ßo para Mission√°rios</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

    :root {
      --primary: #6c63ff;
      --success: #00bf8e;
      --danger: #f5365c;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #adb5bd;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(to top, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%);
      min-height: 100vh;
      padding: 10px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(108, 99, 255, 0.15);
    }

    header {
      background: var(--primary);
      color: white;
      padding: 2rem 1.5rem;
      text-align: center;
    }

    header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    header p { opacity: 0.9; font-size: 1.1rem; }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: #f8f9fa;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .calendar-header h2 {
      font-size: 1.6rem;
      color: var(--dark);
    }

    .nav-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.8rem;
      cursor: pointer;
    }

    .nav-btn:hover {
      background: #5a52e0;
      transform: scale(1.1);
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .weekdays div {
      text-align: center;
      padding: 1rem 0.5rem;
      font-size: 0.9rem;
    }

    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: #e9ecef;
      padding: 5px;
    }

    .day {
      background: white;
      min-height: 100px;
      padding: 0.8rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
    }

    .day:hover {
      background: #f1f3ff;
      transform: translateY(-4px);
      box-shadow: 0 10px 20px rgba(108, 99, 255, 0.1);
    }

    .day.other-month { opacity: 0.4; background: #f8f9fa; }
    .day.today { background: #fff4e6; border: 3px solid #ffa502; font-weight: 700; }

    .day.booked {
      background: var(--success);
      color: white;
    }

    .day-number {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .person {
      font-size: 0.82rem;
      margin-top: auto;
      font-weight: 500;
      word-break: break-all;
      line-height: 1.3;
    }

    .cancel-btn {
      margin-top: 8px;
      background: var(--danger);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      width: 100%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .modal input {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-size: 1rem;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      cursor: pointer;
      margin: 8px;
      min-width: 120px;
    }

    .btn-confirm { background: var(--success); color: white; }
    .btn-cancel, .btn-close { background: var(--gray); color: white; }
    .btn-close { background: var(--primary); }

    .loading { text-align: center; padding: 2rem; color: #666; }

    /* Responsividade extra */
    @media (max-width: 768px) {
      header h1 { font-size: 1.7rem; }
      .calendar-header { padding: 1rem; }
      .calendar-header h2 { font-size: 1.4rem; }
      .day { min-height: 90px; padding: 0.6rem; }
      .day-number { font-size: 1.2rem; }
      .person { font-size: 0.8rem; }
      .weekdays div { font-size: 0.8rem; padding: 0.8rem 0; }
    }

    @media (max-width: 480px) {
      .nav-btn { width: 45px; height: 45px; font-size: 1.5rem; }
      .day { min-height: 70px; padding: 0.3rem; }
      .day-number { font-size: 1rem; margin-bottom: 0.2rem; }
      .person { font-size: 0.7rem; margin-top: 0.2rem; }
      .cancel-btn { font-size: 0.65rem; padding: 2px 5px; margin-top: 0.3rem; }
      header h1 { font-size: 1.5rem; }
      header p { font-size: 0.9rem; }
      .calendar-header h2 { font-size: 1.2rem; }
      .weekdays div { padding: 0.4rem; font-size: 0.75rem; }
      .modal-content { margin: 10px; padding: 1rem; width: 95%; }
      .modal h3 { font-size: 1.1rem; margin-bottom: 1rem; }
      .modal input { padding: 10px; font-size: 0.9rem; }
      .btn { padding: 10px 16px; font-size: 0.9rem; margin: 0 4px; }
    }

    @media (max-width: 360px) {
      .weekdays div {
        font-size: 0.65rem;
        padding: 0.3rem;
      }
      
      .day {
        min-height: 60px;
        padding: 0.2rem;
      }
      
      .day-number {
        font-size: 0.9rem;
      }
      
      .person {
        font-size: 0.6rem;
        line-height: 1.2;
      }
      
      .cancel-btn {
        font-size: 0.6rem;
        padding: 1px 4px;
      }
      
      header h1 {
        font-size: 1.3rem;
      }
      
      header p {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Agendamento de Almo√ßo</h1>
      <p>Para nossos queridos mission√°rios ‚ù§Ô∏è</p>
      <p>Ramo Canind√©</p>
    </header>

    <div class="calendar-header">
      <button id="prevMonth" class="nav-btn">‚Äπ</button>
      <h2 id="monthYear">Dezembro de 2024</h2>
      <button id="nextMonth" class="nav-btn">‚Ä∫</button>
    </div>

    <div class="weekdays">
      <div>Dom</div>
      <div>Seg</div>
      <div>Ter</div>
      <div>Qua</div>
      <div>Qui</div>
      <div>Sex</div>
      <div>S√°b</div>
    </div>

    <div class="days" id="calendarDays">
      <!-- Dias ser√£o gerados pelo JavaScript -->
    </div>
    <div id="loading" class="loading">Carregando agendamentos...</div>
  </div>

  <!-- Modal de Agendamento -->
  <div id="bookingModal" class="modal">
    <div class="modal-content">
      <h3>Agendar Almo√ßo</h3>
      <p><strong>Data:</strong> <span id="selectedDate"></span></p>
      <input type="text" id="personName" placeholder="Seu nome" maxlength="30">
      <input type="tel" id="personPhone" placeholder="Seu telefone" maxlength="15">
      <div class="btn-group">
        <button class="btn btn-confirm" id="confirmBookingBtn">Confirmar</button>
        <button class="btn btn-cancel" id="cancelBookingBtn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>‚úÖ Agendamento Confirmado!</h3>
      <p><strong>Data:</strong> <span id="confirmDate"></span></p>
      <p><strong>Nome:</strong> <span id="confirmName"></span></p>
      <p><strong>Telefone:</strong> <span id="confirmPhone"></span></p>
      <div class="btn-group">
        <button class="btn btn-close" id="closeConfirmBtn">Voltar ao calend√°rio</button>
      </div>
    </div>
  </div>

<script>
// ==================== CONFIGURA√á√ÉO (s√≥ altere aqui) ====================
const GITHUB_TOKEN = localStorage.getItem('github_token') || ""; // Token ser√° salvo no localStorage
const REPO = "ansulima/almoco-missionarios";
const FILE_PATH = "data/bookings.json";
const RAW_URL = `https://raw.githubusercontent.com/${REPO}/master/${FILE_PATH}`;
const API_URL = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;
// =========================================================================

let bookings = {};
let currentMonth, currentYear;
let selectedDate = null;

async function fetchBookings() {
  document.getElementById("loading").style.display = "block";
  
  // Tentar carregar do GitHub primeiro
  if (GITHUB_TOKEN) {
    try {
      const response = await fetch(API_URL, { headers: { Authorization: `token ${GITHUB_TOKEN}` }});
      if (response.ok) {
        const data = await response.json();
        bookings = JSON.parse(atob(data.content));
        localStorage.setItem('bookings', JSON.stringify(bookings));
      } else if (response.status === 404) {
        bookings = {};
        localStorage.setItem('bookings', JSON.stringify(bookings));
      }
    } catch (e) {
      console.log("Falha ao carregar do GitHub, usando localStorage");
    }
  }
  
  // Fallback para localStorage
  if (!GITHUB_TOKEN || Object.keys(bookings).length === 0) {
    const localBookings = localStorage.getItem('bookings');
    if (localBookings) {
      bookings = JSON.parse(localBookings);
    }
  }
  
  document.getElementById("loading").style.display = "none";
  renderCalendar(currentMonth, currentYear);
}

async function saveBookings() {
  // Sempre salvar no localStorage
  localStorage.setItem('bookings', JSON.stringify(bookings));
  
  // Tentar salvar no GitHub se tiver token
  if (GITHUB_TOKEN) {
    try {
      const content = btoa(JSON.stringify(bookings, null, 2));
      const response = await fetch(API_URL, {
        method: "GET",
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
      });
      let sha = null;
      if (response.ok) {
        const data = await response.json();
        sha = data.sha;
      }

      await fetch(API_URL, {
        method: "PUT",
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Atualiza√ß√£o de agendamento de almo√ßo",
          content: content,
          sha: sha
        })
      });
    } catch (e) {
      console.log("Falha ao salvar no GitHub, dados mantidos no localStorage");
    }
  }
}

function renderCalendar(month, year) {
  document.getElementById("calendarDays").innerHTML = "";
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();

  const monthName = new Date(year, month).toLocaleString('pt-BR', { month: 'long' });
  const capitalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
  document.getElementById("monthYear").textContent = `${capitalizedMonth} de ${year}`;

  // Dias vazios do m√™s anterior
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.classList.add('day', 'other-month');
    document.getElementById("calendarDays").appendChild(empty);
  }

  // Dias do m√™s atual
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayEl = document.createElement("div");
    dayEl.className = "day";
    dayEl.innerHTML = `<div class="day-number">${day}</div>`;

    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
      dayEl.classList.add("today");
    }

    if (bookings[dateStr]) {
      dayEl.classList.add("booked");
      dayEl.innerHTML += `<div class="person">${bookings[dateStr].name}</div>
        <button class="cancel-btn" onclick="cancelBooking('${dateStr}', event)">Cancelar</button>`;
    } else {
      dayEl.onclick = () => {
        selectedDate = dateStr;
        document.getElementById("selectedDate").textContent = formatDate(dateStr);
        openModal("bookingModal");
      };
    }

    document.getElementById("calendarDays").appendChild(dayEl);
  }
}

function formatDate(dateStr) {
  const date = new Date(dateStr + 'T12:00:00');
  return date.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })
    .replace(/^\w/, c => c.toUpperCase());
}

function openModal(id) { 
  document.getElementById(id).style.display = "flex";
  
  // Se for modal de agendamento e n√£o tiver token, mostrar aviso
  if (id === "bookingModal" && !GITHUB_TOKEN) {
    const modalContent = document.querySelector("#bookingModal .modal-content");
    if (!document.getElementById("tokenWarning")) {
      const warning = document.createElement("div");
      warning.id = "tokenWarning";
      warning.style.cssText = "background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #856404;";
      warning.innerHTML = `<strong>üí° Dica:</strong> Configure um token GitHub para ver os agendamentos em outros dispositivos. <br><small>Os dados ser√£o sincronizados automaticamente. Sem token, os agendamentos ficam salvos apenas neste navegador.</small>`;
      modalContent.insertBefore(warning, modalContent.querySelector("h3").nextSibling);
    }
  }
}

function closeModal(id) {
  document.getElementById(id).style.display = "none";
  if (id === "bookingModal") {
    document.getElementById("personName").value = "";
    document.getElementById("personPhone").value = "";
  }
}

async function confirmBooking() {
  const name = document.getElementById("personName").value.trim();
  const phone = document.getElementById("personPhone").value.trim();
  if (!name || !phone) {
    alert("Preencha nome e telefone!");
    return;
  }

  bookings[selectedDate] = { name, phone };
  await saveBookings();
  closeModal("bookingModal");
  document.getElementById("confirmDate").textContent = formatDate(selectedDate);
  document.getElementById("confirmName").textContent = name;
  document.getElementById("confirmPhone").textContent = phone;
  openModal("confirmModal");
  renderCalendar(currentMonth, currentYear);
}

async function cancelBooking(dateStr, event) {
  event.stopPropagation();
  if (confirm(`Cancelar agendamento de ${bookings[dateStr].name}?`)) {
    delete bookings[dateStr];
    await saveBookings();
    renderCalendar(currentMonth, currentYear);
  }
}

// Configurar token GitHub
function setupGitHubToken() {
  const token = prompt("Digite seu token GitHub para sincronizar agendamentos entre dispositivos:\n\nOpcional - sem token funciona apenas neste navegador");
  if (token) {
    localStorage.setItem('github_token', token);
    location.reload();
  }
}

// Navega√ß√£o de meses
document.getElementById("prevMonth").onclick = () => { 
  currentMonth--; 
  if (currentMonth < 0) { 
    currentMonth = 11; 
    currentYear--; 
  } 
  renderCalendar(currentMonth, currentYear); 
};

document.getElementById("nextMonth").onclick = () => { 
  currentMonth++; 
  if (currentMonth > 11) { 
    currentMonth = 0; 
    currentYear++; 
  } 
  renderCalendar(currentMonth, currentYear); 
};

// Event listeners dos bot√µes
document.getElementById("confirmBookingBtn").onclick = confirmBooking;
document.getElementById("cancelBookingBtn").onclick = () => closeModal("bookingModal");
document.getElementById("closeConfirmBtn").onclick = () => closeModal("confirmModal");

// Adicionar bot√£o para configurar token
if (!GITHUB_TOKEN) {
  const setupBtn = document.createElement("button");
  setupBtn.textContent = "üîÑ Sincronizar Dispositivos";
  setupBtn.className = "btn";
  setupBtn.style.cssText = "position: fixed; top: 10px; right: 10px; z-index: 1001; font-size: 0.8rem; padding: 8px 12px; background: #28a745;";
  setupBtn.onclick = setupGitHubToken;
  document.body.appendChild(setupBtn);
}

// Iniciar
currentMonth = new Date().getMonth();
currentYear = new Date().getFullYear();
fetchBookings();
</script>
</body>
</html>
