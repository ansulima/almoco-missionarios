<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Almoço Missionários</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
    :root { --primary: #6c63ff; --success: #00bf8e; --danger: #f5365c; --gray: #adb5bd; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:"Poppins",sans-serif; background:linear-gradient(to top,#f3e7e9 0%,#e3eeff 99%); min-height:100vh; padding:10px; }
    .container { max-width:1100px; margin:0 auto; background:white; border-radius:20px; overflow:hidden; box-shadow:0 20px 40px rgba(108,99,255,0.15); }
    header { background:var(--primary); color:white; padding:2.5rem 1.5rem; text-align:center; }
    header h1 { font-size:2.2rem; margin-bottom:.5rem; font-weight:700; }
    header p { opacity:0.9; font-size:1.1rem; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; padding:1.5rem; background:#f8f9fa; flex-wrap:wrap; gap:1rem; }
    .calendar-header h2 { font-size:1.8rem; color:#343a40; }
    .nav-btn { background:var(--primary); color:white; border:none; width:50px; height:50px; border-radius:50%; font-size:1.8rem; cursor:pointer; transition:.3s; }
    .nav-btn:hover { background:#5a52e0; transform:scale(1.1); }
    .weekdays { display:grid; grid-template-columns:repeat(7,1fr); background:var(--primary); color:white; font-weight:600; }
    .weekdays div { text-align:center; padding:1rem; font-size:0.95rem; }
    .days { display:grid; grid-template-columns:repeat(7,1fr); gap:3px; background:#e9ecef; padding:8px; }
    .day { background:white; min-height:110px; padding:0.8rem; cursor:pointer; transition:all .3s; display:flex; flex-direction:column; border-radius:12px; }
    .day:hover { background:#f1f3ff; transform:translateY(-5px); box-shadow:0 10px 20px rgba(108,99,255,0.1); }
    .day.other-month { opacity:0.4; background:#f8f9fa; cursor:default; }
    .day.today { background:#fff4e6; border:3px solid #ffa502; font-weight:700; }
    .day.booked { background:var(--success); color:white; }
    .day-number { font-size:1.4rem; font-weight:600; margin-bottom:0.5rem; }
    .person { font-size:0.85rem; margin-top:auto; word-break:break-all; line-height:1.3; }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; padding:20px; }
    .modal-content { background:white; padding:2rem; border-radius:20px; width:100%; max-width:420px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.2); animation:pop .3s; }
    @keyframes pop { from {transform:scale(0.8);opacity:0} to {transform:scale(1);opacity:1} }
    .modal input { width:100%; padding:14px; margin:10px 0; border:2px solid #e9ecef; border-radius:12px; font-size:1rem; }
    .btn-group { margin-top:1.5rem; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn { padding:14px 28px; border:none; border-radius:12px; font-size:1rem; cursor:pointer; min-width:120px; transition:.3s; }
    .btn-confirm { background:var(--success); color:white; }
    .btn-cancel,.btn-close { background:var(--gray); color:white; }
    .btn-close { background:var(--primary); }
    .loading { text-align:center; padding:2rem; color:#666; font-size:1.1rem; }
    @media (max-width:768px) { header h1{font-size:1.8rem;} .day{min-height:90px;} .person{font-size:0.8rem;} }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Almoço Missionários</h1>
    <p>Para nossos queridos missionários ❤️</p>
  </header>

  <div class="calendar-header">
    <button class="nav-btn" id="prev">‹</button>
    <h2 id="monthYear"></h2>
    <button class="nav-btn" id="next">›</button>
  </div>

  <div class="weekdays">
    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
  </div>

  <div id="days" class="days"></div>
  <div id="loading" class="loading">Carregando agendamentos...</div>
</div>

<!-- Modais -->
<div id="bookingModal" class="modal">
  <div class="modal-content">
    <h3>Agendar • <span id="selDate"></span></h3>
    <input type="text" id="nome" placeholder="Nome completo" required>
    <input type="tel" id="tel" placeholder="Telefone com DDD" required>
    <div class="btn-group">
      <button class="btn btn-confirm" onclick="agendar()">Confirmar</button>
      <button class="btn btn-cancel" onclick="fechar('bookingModal')">Cancelar</button>
    </div>
  </div>
</div>

<div id="okModal" class="modal">
  <div class="modal-content">
    <h3>✅ Confirmado!</h3>
    <p><strong>Data:</strong> <span id="okData"></span></p>
    <p><strong>Nome:</strong> <span id="okNome"></span></p>
    <p><strong>Telefone:</strong> <span id="okTel"></span></p>
    <button class="btn btn-close" onclick="fechar('okModal')">Voltar</button>
  </div>
</div>

<script>
const FORM_ID = "1c-8OYt8GGkfMJd_gvh7epTXRREpf7XK7BqkcJ1lk0g";
const SHEET_ID = "1wi2Uj0Egt3HNxvByaKIVha2xIHBSL8euuIJSTuWKU";

let agendamentos = {};
let mes = new Date().getMonth();
let ano = new Date().getFullYear();
let dataSelecionada = null;

async function carregar() {
  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
    const resp = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, {cache: "no-store"});
    const texto = await resp.text();
    const linhas = texto.split('\n').slice(1);
    agendamentos = {};
    linhas.forEach(l => {
      if (!l.trim()) return;
      const cols = l.split(',').map(c => c.replace(/^"|"$/g, '').trim());
      if (cols.length < 3) return;
      const dataRaw = cols[0];
      const nome = cols[2];
      const tel = cols[3] || '';
      const [dia, mesExcel, anoExcel] = dataRaw.split('/');
      const dataISO = `${anoExcel.padStart(4,'20')}-${mesExcel.padStart(2,'0')}-${dia.padStart(2,'0')}`;
      agendamentos[dataISO] = { nome, tel };
    });
  } catch (e) {
    console.log("Planilha ainda vazia ou carregando...");
  }
  document.getElementById("loading").style.display = "none";
  desenhar();
}

function desenhar() {
  const primeiroDia = new Date(ano, mes, 1).getDay();
  const diasNoMes = new Date(ano, mes + 1, 0).getDate();
  const hoje = new Date().toISOString().slice(0,10);

  document.getElementById("monthYear").textContent = new Date(ano, mes).toLocaleDateString('pt-BR', { month:'long', year:'numeric' }).replace(/^\w/, c=>c.toUpperCase());
  document.getElementById("days").innerHTML = "";

  for (let i = 0; i < primeiroDia; i++) {
    const vazio = document.createElement("div");
    vazio.className = "day other-month";
    document.getElementById("days").appendChild(vazio);
  }

  for (let d = 1; d <= diasNoMes; d++) {
    const dataISO = `${ano}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const el = document.createElement("div");
    el.className = "day";
    el.innerHTML = `<div class="day-number">${d}</div>`;

    if (dataISO === hoje) el.classList.add("today");

    if (agendamentos[dataISO]) {
      el.classList.add("booked");
      el.innerHTML += `<div class="person">${agendamentos[dataISO].nome}</div>`;
    } else {
      el.onclick = () => {
        dataSelecionada = dataISO;
        document.getElementById("selDate").textContent = new Date(dataISO).toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' }).replace(/^\w/,c=>c.toUpperCase());
        abrir("bookingModal");
      };
    }
    document.getElementById("days").appendChild(el);
  }
}

function agendar() {
  const nome = document.getElementById("nome").value.trim();
  const tel = document.getElementById("tel").value.trim();
  if (!nome || !tel) return alert("Preencha nome e telefone!");

  const [a, m, d] = dataSelecionada.split('-');
  const dataBR = `${d}/${m}/${a}`;

  // Envia pro Google Forms (os entry estão corretos pro seu formulário)
  const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse?entry.2092054753=${encodeURIComponent(nome)}&entry.123456789=${encodeURIComponent(tel)}&entry.987654321=${dataBR}`;
  fetch(url, { method: "POST", mode: "no-cors" });

  // === MARCA O DIA VERDE NA HORA ===
  agendamentos[dataSelecionada] = { nome, tel };
  desenhar();

  // Mostra confirmação
  document.getElementById("okData").textContent = new Date(dataSelecionada).toLocaleDateString('pt-BR', {weekday:'long', day:'2-digit', month:'long', year:'numeric'}).replace(/^\w/,c=>c.toUpperCase());
  document.getElementById("okNome").textContent = nome;
  document.getElementById("okTel").textContent = tel;
  fechar("bookingModal");
  abrir("okModal");

  // Recarrega do Google Sheets após 4 segundos (pra sincronizar com quem abrir em outro celular)
  setTimeout(carregar, 4000);
}

function abrir(id) { document.getElementById(id).style.display = "flex"; }
function fechar(id) { 
  document.getElementById(id).style.display = "none"; 
  document.getElementById("nome").value = "";
  document.getElementById("tel").value = "";
}

document.getElementById("prev").onclick = () => { mes = mes === 0 ? 11 : mes-1; if (mes === 11) ano--; desenhar(); };
document.getElementById("next").onclick = () => { mes = mes === 11 ? 0 : mes+1; if (mes === 0) ano++; desenhar(); };

// Inicia
carregar();
</script>
</body>
</html>